<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HTML Writer</title>
    <style>
        :root {
            /* Variables */
            --primary: #6366f1;
            --primary-bg: #e0e7ff;
            --bg-body: #f8fafc;
            --bg-panel: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --sidebar-width: 280px;
            --toolbar-height: 60px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --font-ui: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --font-editor: 'Times New Roman', serif;
            --anim-speed: 0.3s;
        }

        body.dark-mode {
            --bg-body: #0f172a;
            --bg-panel: #1e293b;
            --border: #334155;
            --text-main: #f8fafc;
            --text-muted: #64748b;
            --primary-bg: #312e81;
            --primary: #818cf8;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-ui);
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- ICONS --- */
        .icon { 
            width: 18px; height: 18px; 
            fill: none; stroke: currentColor; 
            stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; 
            pointer-events: none; flex-shrink: 0;
        }

        /* --- LAYOUT --- */
        .app-shell { display: flex; width: 100%; height: 100%; }

        /* Sidebar */
        #sidebar {
            width: var(--sidebar-width);
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column; flex-shrink: 0;
            z-index: 50;
            transition: margin-left var(--anim-speed) cubic-bezier(0.4, 0, 0.2, 1);
        }
        #sidebar.collapsed { margin-left: calc(var(--sidebar-width) * -1); }
        
        .mobile-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 40;
            opacity: 0; pointer-events: none; transition: opacity var(--anim-speed);
            backdrop-filter: blur(2px);
        }
        .mobile-overlay.active { opacity: 1; pointer-events: auto; }

        @media (max-width: 768px) {
            #sidebar {
                position: fixed; height: 100%; left: 0; top: 0;
                transform: translateX(-100%); margin-left: 0;
                transition: transform var(--anim-speed) ease;
                box-shadow: 10px 0 30px rgba(0,0,0,0.3);
            }
            #sidebar.mobile-open { transform: translateX(0); }
        }

        /* Main Area */
        #main {
            flex: 1; display: flex; flex-direction: column; min-width: 0;
            position: relative; background: var(--bg-body);
        }

        /* --- HEADER --- */
        .top-bar {
            height: 50px; background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 10px; gap: 10px;
            flex-shrink: 0;
        }

        #doc-title {
            background: transparent; border: none; font-weight: 600; font-size: 15px;
            color: var(--text-main); flex: 1; padding: 5px; border-radius: 4px;
            transition: opacity 0.2s;
        }
        #doc-title.empty { opacity: 0.5; font-style: italic; pointer-events: none; }
        
        /* --- SLIDING TOOLBAR --- */
        .toolbar-container {
            height: var(--toolbar-height);
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }

        .toolbar-track {
            display: flex;
            width: 200%; /* Two slides */
            height: 100%;
            transition: transform var(--anim-speed) cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        .toolbar-slide {
            width: 50%;
            height: 100%;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 10px;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            -ms-overflow-style: none;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .toolbar-slide::-webkit-scrollbar { display: none; }

        .toolbar-container.show-tools .toolbar-track { transform: translateX(-50%); }

        /* Toolbar Components */
        .cat-btn {
            height: 40px; padding: 0 16px; 
            border-radius: 8px; cursor: pointer;
            font-size: 14px; font-weight: 500; color: var(--text-muted);
            background: transparent; border: 1px solid transparent;
            display: flex; align-items: center; gap: 8px;
            transition: 0.1s; white-space: nowrap; flex-shrink: 0;
        }
        .cat-btn:hover { background: var(--bg-body); color: var(--text-main); border-color: var(--border); }
        body.dark-mode .cat-btn { color: #94a3b8; }
        body.dark-mode .cat-btn:hover { color: #f8fafc; }
        
        .tool-btn {
            height: 38px; padding: 0 14px;
            border-radius: 6px; border: 1px solid transparent;
            background: transparent; color: var(--text-main);
            display: flex; align-items: center; gap: 8px;
            cursor: pointer; transition: 0.1s; flex-shrink: 0;
            font-size: 13px; font-weight: 500;
        }
        .tool-btn span { white-space: nowrap; }
        .tool-btn:hover { background: var(--bg-body); border-color: var(--border); }
        .tool-btn.active { background: var(--primary-bg); color: var(--primary); border-color: rgba(99, 102, 241, 0.2); }

        .back-btn {
            height: 38px; width: 38px; border-radius: 50%;
            background: var(--bg-body); border: 1px solid var(--border);
            color: var(--text-muted); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            margin-right: 5px; flex-shrink: 0; position: sticky; left: 0; z-index: 10;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        .back-btn:hover { color: var(--primary); border-color: var(--primary); }

        .tool-select {
            height: 38px; border-radius: 6px; border: 1px solid var(--border);
            background: var(--bg-body); color: var(--text-main);
            font-size: 13px; padding: 0 8px; outline: none; flex-shrink: 0;
        }
        .tool-select option { background: var(--bg-panel); color: var(--text-main); }
        .divider { width: 1px; height: 24px; background: var(--border); margin: 0 4px; flex-shrink: 0; }

        /* --- EDITOR AREA --- */
        .editor-scroller {
            flex: 1; overflow-y: auto; padding: 40px 20px;
            display: flex; justify-content: center;
            background: var(--bg-body);
            position: relative;
        }

        .page {
            background: white; width: 100%; max-width: 816px; min-height: 1000px;
            padding: 60px; box-shadow: var(--shadow);
            color: #000; font-family: var(--font-editor); font-size: 16px; line-height: 1.6;
            outline: none; display: none;
        }
        body.dark-mode .page { background: #1e293b; color: #e2e8f0; }

        /* Empty State */
        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; width: 100%;
            user-select: none;
        }
        
        .empty-icon { 
            width: 100px; height: 100px; margin-bottom: 20px;
            fill: none; /* No Fill */
            stroke: currentColor;
            stroke-width: 1.5;
            color: #000; opacity: 0.1; /* Light mode: Black, 10% opacity */
        }
        
        .empty-text { font-size: 20px; font-weight: 600; color: var(--text-muted); opacity: 0.5; }

        body.dark-mode .empty-icon {
            color: #fff; opacity: 0.1; /* Dark mode: White, 10% opacity */
        }

        /* Editor Content Styles */
        .page img { max-width: 100%; height: auto; }
        .page table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .page td, .page th { border: 1px solid #94a3b8; padding: 8px; }
        .page blockquote { border-left: 3px solid var(--primary); padding-left: 10px; margin: 10px 0; color: var(--text-muted); font-style: italic; }
        .page pre { background: #333; color: #fff; padding: 10px; border-radius: 4px; overflow-x: auto; font-family: monospace; }
        .page a { color: var(--primary); text-decoration: underline; }

        .source-view {
            position: absolute; inset: 0; z-index: 10; background: #1e293b; color: #a5b4fc;
            padding: 20px; font-family: monospace; border: none; resize: none; display: none;
            width: 100%; height: 100%; font-size: 14px;
        }

        /* --- SIDEBAR COMPONENTS --- */
        .sidebar-header { padding: 16px; border-bottom: 1px solid var(--border); }
        .file-list { flex: 1; overflow-y: auto; padding: 8px; }
        .file-item {
            padding: 12px; margin-bottom: 4px; border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; gap: 10px;
            color: var(--text-muted); font-size: 14px; transition: 0.1s;
        }
        .file-item:hover { background: var(--bg-body); color: var(--text-main); }
        .file-item.active { background: var(--primary-bg); color: var(--primary); font-weight: 600; }
        
        .sb-actions { display: flex; gap: 8px; margin-bottom: 12px; }
        .sb-btn { flex: 1; height: 36px; border: 1px solid var(--border); background: var(--bg-body); border-radius: 6px; color: var(--text-main); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;}
        .sb-btn:hover { border-color: var(--primary); color: var(--primary); }
        .sb-btn.danger:hover { border-color: var(--danger); color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        
        .search-wrap { position: relative; }
        .search-input {
            width: 100%; padding: 8px 10px 8px 34px;
            border-radius: 6px; border: 1px solid var(--border);
            background: var(--bg-body); color: var(--text-main); font-size: 13px;
        }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 14px; height: 14px; color: var(--text-muted); }

        /* --- BOTTOM BAR --- */
        .status-bar {
            height: 30px; background: var(--bg-panel); border-top: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px; font-size: 11px; color: var(--text-muted); flex-shrink: 0;
        }

        /* --- TOAST --- */
        #toast {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 30px;
            font-size: 13px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 200;
            backdrop-filter: blur(4px); text-align: center;
        }
        #toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* --- MODAL --- */
        .modal-wrap {
            position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px);
        }
        .modal {
            background: var(--bg-panel); width: 90%; max-width: 350px; padding: 20px;
            border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        .modal h3 { margin: 0 0 15px 0; font-size: 16px; }
        .modal input { width: 100%; padding: 10px; margin-bottom: 15px; background: var(--bg-body); border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 10px; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 500; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost { background: transparent; color: var(--text-muted); }

        /* --- FULLSCREEN OVERRIDES --- */
        body.fullscreen #sidebar, 
        body.fullscreen .top-bar, 
        body.fullscreen .toolbar-container, 
        body.fullscreen .status-bar { display: none !important; }
        
        body.fullscreen .editor-scroller { padding: 0; background: #000; }
        body.fullscreen .page { 
            max-width: 100%; min-height: 100vh; border-radius: 0; 
            padding: 40px; margin: 0; display: block;
        }
        body.fullscreen .source-view { z-index: 200; }

    </style>
    <script>
        if (localStorage.getItem('appTheme') === 'dark') {
            document.documentElement.classList.add('dark-mode');
            window.addEventListener('DOMContentLoaded', () => document.body.classList.add('dark-mode'));
        }
    </script>
</head>
<body>

    <div class="mobile-overlay" id="mobile-overlay"></div>
    <div class="modal-wrap" id="modal-wrap"><div class="modal" id="modal-content"></div></div>
    <div id="toast">Press ESC or Long Hold to exit</div>

    <div class="app-shell">
        <div id="sidebar">
            <div class="sidebar-header">
                <div class="sb-actions">
                    <button class="sb-btn" id="btn-new" title="New Document"><svg class="icon" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg></button>
                    <button class="sb-btn" id="btn-rename" title="Rename"><svg class="icon" viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg></button>
                    <button class="sb-btn" id="btn-download" title="Export HTML"><svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg></button>
                    <button class="sb-btn danger" id="btn-delete" title="Delete"><svg class="icon" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                </div>
                <div class="search-wrap">
                    <svg class="search-icon icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="file-search" class="search-input" placeholder="Search files...">
                </div>
            </div>
            <div class="file-list" id="file-list"></div>
        </div>

        <div id="main">
            <div class="top-bar">
                <button class="tool-btn" id="toggle-sidebar" style="padding:0 8px;"><svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg></button>
                <input type="text" id="doc-title" value="Nothing" readonly class="empty">
                <button class="tool-btn" id="toggle-theme" style="padding:0 8px;"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg></button>
            </div>

            <div class="toolbar-container" id="toolbar-container">
                <div class="toolbar-track">
                    <div class="toolbar-slide" id="toolbar-cats"></div>
                    <div class="toolbar-slide tools-view">
                        <button class="back-btn" id="toolbar-back"><svg class="icon" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg></button>
                        <div style="display:flex; gap: 5px; align-items:center;" id="toolbar-tools-area"></div>
                    </div>
                </div>
            </div>

            <div class="editor-scroller">
                <div id="empty-state" class="empty-state">
                    <svg class="empty-icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <div class="empty-text">No File Selected</div>
                </div>
                
                <div id="editor" class="page" contenteditable="true"></div>
                <textarea id="source-editor" class="source-view"></textarea>
            </div>

            <div class="status-bar">
                <span id="status-msg">Ready</span>
                <span id="word-count">0 Words</span>
            </div>
        </div>
    </div>

    <script>
        const ICONS = {
            home: '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>',
            format: '<polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line>',
            insert: '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line>',
            view: '<path d="M1 12s4-8 11-8 11 8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>',
            undo: '<path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/>',
            redo: '<path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"/>',
            bold: '<path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"/>',
            italic: '<line x1="19" y1="4" x2="10" y2="4"/><line x1="14" y1="20" x2="5" y2="20"/><line x1="15" y1="4" x2="9" y2="20"/>',
            underline: '<path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"/><line x1="4" y1="21" x2="20" y2="21"/>',
            strike: '<line x1="5" y1="12" x2="19" y2="12"/><path d="M16 6C16 6 14.5 4 12 4C9.5 4 8 6 8 6"/><path d="M8 18C8 18 9.5 20 12 20C14.5 20 16 18 16 18"/>',
            left: '<line x1="17" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="17" y1="18" x2="3" y2="18"/>',
            center: '<line x1="21" y1="10" x2="3" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="3" y2="18"/>',
            right: '<line x1="21" y1="10" x2="7" y2="10"/><line x1="21" y1="6" x2="3" y2="6"/><line x1="21" y1="14" x2="3" y2="14"/><line x1="21" y1="18" x2="7" y2="18"/>',
            listUl: '<line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>',
            listOl: '<line x1="10" y1="6" x2="21" y2="6"/><line x1="10" y1="12" x2="21" y2="12"/><line x1="10" y1="18" x2="21" y2="18"/><path d="M4 6h1v4"/><path d="M4 10h2"/><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"/>',
            link: '<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>',
            image: '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>',
            full: '<polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/>',
            source: '<polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>',
            sub: '<path d="m4 16 3-8 3 8m-5-3h4"/><path d="m19 19-3 3-3-3m3 3v-9"/>', 
            sup: '<path d="m4 16 3-8 3 8m-5-3h4"/><path d="m19 5-3 3-3-3m3 3v9"/>',
            clear: '<path d="M18 6 6 18M6 6l12 12"/>',
            color: '<circle cx="12" cy="12" r="10"/><path d="M12 12v6"/>',
            table: '<rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/>',
            print: '<polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/>'
        };

        const CATEGORIES = {
            'Home': ICONS.home,
            'Format': ICONS.format,
            'Insert': ICONS.insert,
            'View': ICONS.view
        };

        const TOOLS_CONFIG = {
            'Home': [
                { type: 'btn', icon: ICONS.undo, cmd: 'undo', title: 'Undo' },
                { type: 'btn', icon: ICONS.redo, cmd: 'redo', title: 'Redo' },
                { type: 'sep' },
                { type: 'btn', icon: ICONS.bold, cmd: 'bold', title: 'Bold' },
                { type: 'btn', icon: ICONS.italic, cmd: 'italic', title: 'Italic' },
                { type: 'btn', icon: ICONS.underline, cmd: 'underline', title: 'Underline' },
                { type: 'btn', icon: ICONS.strike, cmd: 'strikethrough', title: 'Strike' },
                { type: 'sep' },
                { type: 'select', id:'font-fam', cmd: 'fontName', opts: [['Inter','Default'],['Arial','Arial'],['Helvetica','Helvetica'],['Times New Roman','Times'],['Courier New','Courier'],['Georgia','Georgia'],['Verdana','Verdana'],['Trebuchet MS','Trebuchet'],['Impact','Impact'],['Comic Sans MS','Comic Sans']] },
                { type: 'select', cmd: 'fontSize', opts: [['3','Normal'],['1','Tiny'],['2','Small'],['4','Large'],['5','Huge'],['6','Giant']] },
                { type: 'color', cmd: 'foreColor', title: 'Text Color' },
                { type: 'color', cmd: 'hiliteColor', title: 'Highlight' }
            ],
            'Format': [
                { type: 'btn', icon: ICONS.left, cmd: 'justifyLeft', title: 'Left' },
                { type: 'btn', icon: ICONS.center, cmd: 'justifyCenter', title: 'Center' },
                { type: 'btn', icon: ICONS.right, cmd: 'justifyRight', title: 'Right' },
                { type: 'sep' },
                { type: 'select', cmd: 'formatBlock', opts: [['P','Paragraph'],['H1','Heading 1'],['H2','Heading 2'],['H3','Heading 3'],['BLOCKQUOTE','Quote'],['PRE','Code Block']] },
                { type: 'sep' },
                { type: 'btn', icon: ICONS.listUl, cmd: 'insertUnorderedList', title: 'Bullets' },
                { type: 'btn', icon: ICONS.listOl, cmd: 'insertOrderedList', title: 'Numbers' },
                { type: 'sep' },
                { type: 'btn', icon: ICONS.sub, cmd: 'subscript', title: 'Sub' },
                { type: 'btn', icon: ICONS.sup, cmd: 'superscript', title: 'Super' },
                { type: 'btn', icon: ICONS.clear, cmd: 'removeFormat', title: 'Clear' }
            ],
            'Insert': [
                { type: 'btn', icon: ICONS.link, custom: 'link', title: 'Link' },
                { type: 'btn', icon: ICONS.image, custom: 'image', title: 'Image' },
                { type: 'btn', icon: ICONS.table, custom: 'table', title: 'Table' },
                { type: 'btn', icon: ICONS.listUl, cmd: 'insertHorizontalRule', title: 'Divider' },
                { type: 'btn', icon: '<rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>', custom: 'date', title: 'Date' }
            ],
            'View': [
                { type: 'btn', icon: ICONS.full, custom: 'fullscreen', title: 'Fullscreen' },
                { type: 'btn', icon: ICONS.source, custom: 'source', title: 'Source' },
                { type: 'btn', icon: ICONS.print, custom: 'print', title: 'Print' }
            ]
        };

        let db;
        let currentDocId = null;
        let isMobile = window.innerWidth <= 768;
        let longPressTimer;

        const UI = {
            $: id => document.getElementById(id),
            
            toggleSidebar(force) {
                const sb = UI.$('sidebar');
                const ov = UI.$('mobile-overlay');
                const isMobileOpen = sb.classList.contains('mobile-open');

                if (window.innerWidth > 768) {
                    if (force === false) sb.classList.add('collapsed');
                    else if (force === true) sb.classList.remove('collapsed');
                    else sb.classList.toggle('collapsed');
                    ov.classList.remove('active');
                } else {
                    const shouldOpen = force !== undefined ? force : !isMobileOpen;
                    if (shouldOpen) {
                        sb.classList.add('mobile-open');
                        ov.classList.add('active');
                    } else {
                        sb.classList.remove('mobile-open');
                        ov.classList.remove('active');
                    }
                }
            },

            toast(msg) {
                const t = UI.$('toast');
                t.innerText = msg;
                t.classList.add('visible');
                setTimeout(() => t.classList.remove('visible'), 3000);
            },

            modal(html) {
                const w = UI.$('modal-wrap');
                UI.$('modal-content').innerHTML = html;
                w.style.display = 'flex';
                return { close: () => w.style.display = 'none' };
            },

            prompt(title, cb) {
                const m = UI.modal(`<h3>${title}</h3><input id="prompt-in"><div class="modal-btns"><button class="btn btn-ghost" id="p-cancel">Cancel</button><button class="btn btn-primary" id="p-ok">OK</button></div>`);
                UI.$('p-cancel').onclick = m.close;
                UI.$('p-ok').onclick = () => { cb(UI.$('prompt-in').value); m.close(); };
                setTimeout(() => UI.$('prompt-in').focus(), 50);
            },

            renderCategories() {
                const catContainer = UI.$('toolbar-cats');
                catContainer.innerHTML = '';
                Object.keys(CATEGORIES).forEach(cat => {
                    const btn = document.createElement('button');
                    btn.className = 'cat-btn';
                    btn.innerHTML = `<svg class="icon" viewBox="0 0 24 24">${CATEGORIES[cat]}</svg> <span>${cat}</span>`;
                    btn.onclick = () => UI.openCategory(cat);
                    catContainer.appendChild(btn);
                });
            },

            openCategory(cat) {
                if (!currentDocId) return;
                const toolArea = UI.$('toolbar-tools-area');
                toolArea.innerHTML = '';
                
                TOOLS_CONFIG[cat].forEach(t => {
                    if (t.type === 'sep') {
                        const d = document.createElement('div');
                        d.className = 'divider';
                        toolArea.appendChild(d);
                    } else if (t.type === 'btn' || t.type === 'color') {
                        const b = document.createElement('button');
                        b.className = 'tool-btn';
                        b.title = t.title || '';
                        const iconHtml = `<svg class="icon" viewBox="0 0 24 24">${t.icon || '<circle cx="12" cy="12" r="10"/>'}</svg>`;
                        b.innerHTML = `${iconHtml}<span>${t.title}</span>`;
                        
                        if (t.type === 'color') {
                            b.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l3.5 14.5L13 18l5-5L18 13l-1.5-7.5L2 2z"/></svg><span>${t.title}</span>`;
                            b.onclick = () => {
                                const i = document.createElement('input'); i.type = 'color';
                                i.onchange = e => { document.execCommand(t.cmd, false, e.target.value); };
                                i.click();
                            };
                        } else {
                            b.onclick = () => {
                                if (t.cmd) document.execCommand(t.cmd, false, null);
                                else if (t.custom) App.handleCustom(t.custom);
                                UI.updateToolbarState();
                            };
                            if (t.cmd) b.dataset.cmd = t.cmd;
                        }
                        toolArea.appendChild(b);
                    } else if (t.type === 'select') {
                        const s = document.createElement('select');
                        s.className = 'tool-select';
                        if(t.id) s.id = t.id; 
                        t.opts.forEach(o => {
                            const op = document.createElement('option');
                            op.value = o[0]; op.innerText = o[1];
                            s.appendChild(op);
                        });
                        s.onchange = () => { 
                            document.execCommand(t.cmd, false, s.value); 
                            UI.updateToolbarState();
                        };
                        s.dataset.cmd = t.cmd;
                        toolArea.appendChild(s);
                    }
                });

                UI.$('toolbar-container').classList.add('show-tools');
                UI.updateToolbarState();
            },

            closeTools() {
                UI.$('toolbar-container').classList.remove('show-tools');
            },

            updateToolbarState() {
                document.querySelectorAll('.tool-btn[data-cmd]').forEach(b => {
                    if (document.queryCommandState(b.dataset.cmd)) b.classList.add('active');
                    else b.classList.remove('active');
                });

                const fontSelect = UI.$('font-fam');
                if (fontSelect) {
                    let font = document.queryCommandValue('fontName');
                    font = font.replace(/['"]+/g, '');
                    let match = false;
                    for(let i=0; i<fontSelect.options.length; i++){
                        if(fontSelect.options[i].value.toLowerCase() === font.toLowerCase()){
                            fontSelect.selectedIndex = i;
                            match = true;
                            break;
                        }
                    }
                    if(!match) fontSelect.selectedIndex = -1; 
                }
            }
        };

        const App = {
            async init() {
                await this.initDB();
                this.bindEvents();
                this.refreshFiles();
                UI.renderCategories();
                this.setNoFileState();
            },

            initDB() {
                return new Promise(r => {
                    const req = indexedDB.open("UltHTMLWriter_V2", 1);
                    req.onupgradeneeded = e => e.target.result.createObjectStore("docs", { keyPath: "id", autoIncrement: true });
                    req.onsuccess = e => { db = e.target.result; r(); };
                });
            },

            bindEvents() {
                const ed = UI.$('editor');
                
                ed.addEventListener('mouseup', UI.updateToolbarState);
                ed.addEventListener('keyup', () => {
                    UI.updateToolbarState();
                    this.autoSave();
                    this.updateWordCount();
                });

                UI.$('toolbar-back').onclick = UI.closeTools;
                UI.$('toggle-sidebar').onclick = () => UI.toggleSidebar();
                UI.$('mobile-overlay').onclick = () => UI.toggleSidebar(false);
                
                // MOUSE WHEEL SCROLL FIX
                document.querySelectorAll('.toolbar-slide').forEach(el => {
                    el.addEventListener('wheel', (e) => {
                        if (e.deltaY !== 0) {
                            e.preventDefault();
                            el.scrollLeft += e.deltaY;
                        }
                    });
                });

                UI.$('toggle-theme').onclick = () => {
                    document.body.classList.toggle('dark-mode');
                    document.documentElement.classList.toggle('dark-mode');
                    const isDark = document.body.classList.contains('dark-mode');
                    localStorage.setItem('appTheme', isDark ? 'dark' : 'light');
                };

                UI.$('btn-new').onclick = () => UI.prompt("Document Name", name => {
                    if (name) this.saveDoc({ title: name, content: '<p>Start typing...</p>' }).then((id) => this.loadDoc(id));
                });
                
                // NEW: Rename Function
                UI.$('btn-rename').onclick = () => {
                    if (!currentDocId) return UI.toast("No file selected");
                    UI.prompt("Rename File", (newName) => {
                        if(newName) {
                            UI.$('doc-title').value = newName;
                            this.autoSave();
                        }
                    });
                };

                UI.$('btn-delete').onclick = () => {
                    if (currentDocId && confirm("Delete this file?")) {
                        const tx = db.transaction("docs", "readwrite");
                        tx.objectStore("docs").delete(currentDocId);
                        tx.oncomplete = () => {
                            this.setNoFileState();
                            this.refreshFiles();
                        };
                    }
                };

                UI.$('btn-download').onclick = () => {
                    if(!currentDocId) return;
                    const blob = new Blob([UI.$('editor').innerHTML], {type:'text/html'});
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = (UI.$('doc-title').value || 'document') + '.html';
                    a.click();
                };

                UI.$('file-search').oninput = e => this.refreshFiles(e.target.value);
                UI.$('doc-title').oninput = () => this.autoSave();

                document.addEventListener('keydown', e => {
                    if(e.key === 'Escape' && document.body.classList.contains('fullscreen')) {
                        App.toggleFullscreen(false);
                    }
                });

                const startLongPress = (e) => {
                    if(!document.body.classList.contains('fullscreen')) return;
                    longPressTimer = setTimeout(() => App.toggleFullscreen(false), 1000);
                };
                const endLongPress = () => clearTimeout(longPressTimer);
                
                document.addEventListener('mousedown', startLongPress);
                document.addEventListener('touchstart', startLongPress);
                document.addEventListener('mouseup', endLongPress);
                document.addEventListener('touchend', endLongPress);
            },

            handleCustom(action) {
                const ed = UI.$('editor');
                if (action === 'link') UI.prompt("Enter URL", url => document.execCommand('createLink', false, url));
                if (action === 'image') UI.prompt("Enter Image URL", url => document.execCommand('insertImage', false, url));
                if (action === 'table') document.execCommand('insertHTML', false, '<table style="width:100%; border:1px solid #ccc;"><tr><td>Cell 1</td><td>Cell 2</td></tr><tr><td>Cell 3</td><td>Cell 4</td></tr></table>');
                if (action === 'date') document.execCommand('insertHTML', false, new Date().toLocaleDateString());
                if (action === 'print') window.print();
                
                if (action === 'fullscreen') this.toggleFullscreen(true);

                if (action === 'source') {
                    const src = UI.$('source-editor');
                    if (src.style.display === 'block') {
                        ed.innerHTML = src.value;
                        src.style.display = 'none';
                    } else {
                        src.value = ed.innerHTML;
                        src.style.display = 'block';
                        UI.toast("Editing Code. Press ESC to exit Fullscreen.");
                    }
                }
            },

            toggleFullscreen(active) {
                if(active) {
                    document.body.classList.add('fullscreen');
                    UI.toast("Press ESC or Long Hold to exit");
                } else {
                    document.body.classList.remove('fullscreen');
                }
            },

            setNoFileState() {
                currentDocId = null;
                // Switch Visibility
                UI.$('editor').style.display = 'none';
                UI.$('empty-state').style.display = 'flex';
                
                UI.$('doc-title').value = "Nothing";
                UI.$('doc-title').classList.add('empty');
                UI.$('doc-title').readOnly = true;
                UI.$('status-msg').innerText = "No File Selected";
                UI.closeTools();
            },

            async refreshFiles(query = '') {
                const tx = db.transaction("docs", "readonly");
                const store = tx.objectStore("docs");
                const req = store.getAll();
                req.onsuccess = () => {
                    const list = UI.$('file-list');
                    list.innerHTML = '';
                    const files = req.result.sort((a,b) => b.id - a.id);
                    files.forEach(f => {
                        if (query && !f.title.toLowerCase().includes(query.toLowerCase())) return;
                        const el = document.createElement('div');
                        el.className = `file-item ${f.id === currentDocId ? 'active' : ''}`;
                        el.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path></svg> <span>${f.title}</span>`;
                        el.onclick = () => this.loadDoc(f.id);
                        list.appendChild(el);
                    });
                };
            },

            loadDoc(id) {
                const tx = db.transaction("docs", "readonly");
                tx.objectStore("docs").get(id).onsuccess = e => {
                    const doc = e.target.result;
                    if (doc) {
                        currentDocId = doc.id;
                        const ed = UI.$('editor');
                        ed.innerHTML = doc.content;
                        
                        // Switch Visibility
                        UI.$('empty-state').style.display = 'none';
                        ed.style.display = 'block';
                        
                        ed.focus();
                        
                        const titleInput = UI.$('doc-title');
                        titleInput.value = doc.title;
                        titleInput.classList.remove('empty');
                        titleInput.readOnly = false;

                        UI.$('status-msg').innerText = "Ready";
                        this.updateWordCount();

                        if (isMobile) UI.toggleSidebar(false);
                        this.refreshFiles();
                    }
                };
            },

            saveDoc(doc) {
                return new Promise(r => {
                    const tx = db.transaction("docs", "readwrite");
                    tx.objectStore("docs").put(doc).onsuccess = e => {
                        currentDocId = e.target.result;
                        r(currentDocId);
                    };
                });
            },

            autoSave() {
                if (!currentDocId) return;
                clearTimeout(this.saveTimer);
                UI.$('status-msg').innerText = "Saving...";
                this.saveTimer = setTimeout(() => {
                    this.saveDoc({
                        id: currentDocId,
                        title: UI.$('doc-title').value,
                        content: UI.$('editor').innerHTML
                    }).then(() => {
                        UI.$('status-msg').innerText = "Saved";
                        this.refreshFiles();
                    });
                }, 1000);
            },

            updateWordCount() {
                const txt = UI.$('editor').innerText || "";
                const count = txt.trim().length === 0 ? 0 : txt.trim().split(/\s+/).length;
                UI.$('word-count').innerText = count + " Words";
            }
        };

        App.init();

    </script>
</body>
</html>
